version: '{build}'
clone_folder: c:\projects\mars


# https://www.appveyor.com/docs/build-environment/#build-worker-images
image: Visual Studio 2019

# cache:
# - C:\Program Files\Microsoft 
# - C:\Program Files (x86)

install:
# Download Submodules
- git submodule update --init --recursive
# Install MS-MPI
- ps: Start-FileDownload 'https://download.microsoft.com/download/B/2/E/B2EB83FE-98C2-4156-834A-E1711E6884FB/MSMpiSetup.exe'
- MSMpiSetup.exe -unattend
- set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%

# Install MS-MPI SDK
- ps: Start-FileDownload 'https://download.microsoft.com/download/B/2/E/B2EB83FE-98C2-4156-834A-E1711E6884FB/msmpisdk.msi'
- msmpisdk.msi /passive
- set PATH=C:\Program Files\Microsoft MPI\Bin;%PATH%


# Install Kokkos
- cd C:\
- mkdir kg
- cd kg
- ps: Start-FileDownload 'https://github.com/kokkos/kokkos/archive/refs/tags/3.5.00.tar.gz'
- 7z x 3.5.00.tar.gz -so | 7z x -si -ttar > nul
- cd kokkos-3.5.00
- mkdir build &&
    cd build &&
    cmake .. -DKokkos_ENABLE_TESTS=OFF -DCMAKE_INSTALL_PREFIX=C:\projects\installations\kokkos -DCMAKE_CXX_FLAGS="/W0 /EHsc" -DKokkos_ENABLE_DEPRECATED_CODE_3=ON -DKokkos_ENABLE_DEPRECATION_WARNINGS=OFF &&
    cmake --build . --target install

#Install KokkosKernels
# - cd C:\
# - mkdir kkg
# - cd kkg
# - ps: Start-FileDownload 'https://github.com/kokkos/kokkos-kernels/archive/refs/tags/3.5.00.tar.gz'
# - 7z x 3.5.00.tar.gz -so | 7z x -si -ttar > nul
# - cd kokkos-kernels-3.5.00
# - mkdir build &&
#     cd build &&
#     cmake .. -DKokkosKernels_ENABLE_TESTS=OFF -DCMAKE_INSTALL_PREFIX=C:\projects\installations\kokkos-kernels  -DCMAKE_CXX_FLAGS="/W0 /EHsc" -DKokkos_DIR=C:\projects\installations\kokkos\lib\cmake\Kokkos -DCMAKE_CXX_FLAGS="-D__restrict__=__restrict" &&
#     cmake --build . --target install


# Mars
before_build:
- cd c:\projects\mars
- cmake -Ball_builds -DMARS_ENABLE_TESTING=ON -DMARS_ENABLE_BENCHMARK=ON -DCMAKE_INSTALL_PREFIX=install  -DMPI_C_INCLUDE_PATH="C:\Program Files (x86)\Microsoft SDKs\MPI\Include" -DMPI_C_LIBRARIES="C:\Program Files (x86)\Microsoft SDKs\MPI\Lib\x86\msmpi.lib" -DMPI_CXX_LIBRARIES="C:\Program Files (x86)\Microsoft SDKs\MPI\Lib\x86\msmpi.lib" -DMPI_CXX_INCLUDE_PATH="C:\Program Files (x86)\Microsoft SDKs\MPI\Include -DKokkos_DIR=C:\projects\installations\kokkos\lib\cmake\Kokkos -DMARS_ENABLE_KOKKOS=ON -DMARS_ENABLE_KOKKOS_KERNELS=OFF  #-DCMAKE_VERBOSE_MAKEFILE=ON
# -DBUILD_SHARED_LIBS=ON

build_script:
- cmake --build all_builds --config Release
- ls -lah all_builds
- ls -lah all_builds/Release
- cmake --build all_builds --config Release --target install


after_build:
- .\all_builds\Release\mars_test.exe
- .\all_builds\Release\mars_bench.exe
# - cmake --build all_builds --config Release --target test_install
